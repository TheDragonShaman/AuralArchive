{% extends 'base.html' %}

{% block content %}
<div class="space-y-8">
    <div class="flex flex-col gap-6">
        <section class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
            <div class="card bg-base-200 border border-base-content/10 shadow-sm">
                <div class="card-body p-5">
                    <span class="text-xs uppercase tracking-[0.2em] text-base-content/50">Total Books</span>
                    <span class="text-2xl font-semibold">{{ library_stats.get('total_books', 0) }}</span>
                    <span class="text-xs text-base-content/60">Across your entire collection</span>
                </div>
            </div>
            <div class="card bg-base-200 border border-base-content/10 shadow-sm">
                <div class="card-body p-5">
                    <span class="text-xs uppercase tracking-[0.2em] text-base-content/50">Authors</span>
                    <span class="text-2xl font-semibold">{{ library_stats.get('total_authors', 0) }}</span>
                    <span class="text-xs text-base-content/60">Unique voices in the archive</span>
                </div>
            </div>
            <div class="card bg-base-200 border border-base-content/10 shadow-sm">
                <div class="card-body p-5">
                    <span class="text-xs uppercase tracking-[0.2em] text-base-content/50">Listening Hours</span>
                    <span class="text-2xl font-semibold">{{ library_stats.get('total_runtime_hours', 0) }}</span>
                    <span class="text-xs text-base-content/60">Estimated total runtime</span>
                </div>
            </div>
            <div class="card bg-base-200 border border-base-content/10 shadow-sm">
                <div class="card-body p-5">
                    <span class="text-xs uppercase tracking-[0.2em] text-base-content/50">This Week</span>
                    <span class="text-2xl font-semibold">{{ activity_stats.get('total_activity', 0) }}</span>
                    <span class="text-xs text-base-content/60">Additions & updates in 7 days</span>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 xl:grid-cols-3 gap-6 items-start">
            <div class="xl:col-span-2 space-y-4">
                <header class="flex items-center justify-between">
                    <div>
                        <h2 class="text-sm font-semibold uppercase tracking-[0.25em] text-base-content/60">Recent Additions</h2>
                        <p class="text-xs text-base-content/50">Fresh stories that just entered your library</p>
                    </div>
                </header>
                {% if recent_books %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for book in recent_books %}
                            {% set art = book['Cover Image'] or url_for('static', filename='images/auralarchive_logo.png') %}
                            {% set last_activity = book['Updated At'] or book['Created At'] %}
                            <article class="card bg-base-200 border border-base-content/10">
                                <div class="card-body p-4 flex flex-col lg:flex-row gap-4">
                                    <img src="{{ art }}" alt="{{ book['Title'] }}" class="w-[150px] h-[150px] object-cover rounded-xl border border-base-content/10" loading="lazy">
                                    <div class="flex-1 flex flex-col">
                                        <h3 class="text-sm font-semibold leading-tight">{{ book['Title'] }}</h3>
                                        <p class="text-xs text-base-content/60">{{ book['Author'] }}</p>
                                        <div class="mt-2 flex flex-wrap gap-2 text-[0.65rem] text-base-content/60">
                                            {% if book['Status'] %}<span class="badge badge-ghost uppercase tracking-wide">{{ book['Status'] }}</span>{% endif %}
                                            {% if book['Overall Rating'] and book['Overall Rating'] != 'N/A' %}
                                                <span class="badge badge-ghost"><i class="fas fa-star mr-1"></i>{{ book['Overall Rating'] }}</span>
                                            {% endif %}
                                            {% if book['Runtime'] %}<span class="badge badge-ghost"><i class="fas fa-clock mr-1"></i>{{ book['Runtime'] }}</span>{% endif %}
                                        </div>
                                        <p class="mt-3 text-[0.7rem] text-base-content/50">
                                            {{ (book['Summary'] or 'No summary yet.')|striptags|truncate(140, True, 'â€¦') }}
                                        </p>
                                        <p class="mt-auto pt-3 text-[0.65rem] uppercase tracking-[0.2em] text-base-content/40">{{ last_activity or 'New addition' }}</p>
                                    </div>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <span>No recent additions recorded yet. Start exploring the catalog!</span>
                    </div>
                {% endif %}
            </div>
            <aside class="flex flex-col gap-6 xl:pt-[3.25rem]">
                <section class="card bg-base-200 border border-base-content/10">
                    <div class="card-body p-5 space-y-3">
                        <h2 class="text-sm font-semibold uppercase tracking-[0.25em] text-base-content/60">Active Downloads</h2>
                        {% if download_snapshot.connected and download_snapshot.downloads %}
                            <ul class="space-y-3 text-sm">
                                {% for torrent in download_snapshot.downloads %}
                                    <li class="border border-base-content/10 rounded-lg p-3 bg-base-100">
                                        <p class="font-semibold text-base-content/80 leading-snug">{{ torrent.name }}</p>
                                        <div class="mt-2 flex items-center justify-between text-xs text-base-content/60">
                                            <span>{{ (torrent.progress or 0)|round(1) }}%</span>
                                            <span>{{ (torrent.download_speed or 0)/1024|round(1) }} KB/s</span>
                                        </div>
                                        <progress class="progress progress-primary w-full h-2 mt-2" value="{{ torrent.progress or 0 }}" max="100"></progress>
                                        <div class="mt-2 flex items-center gap-2 text-[0.65rem] text-base-content/50 uppercase tracking-[0.2em]">
                                            <span>{{ torrent.state }}</span>
                                            {% if torrent.category %}<span>&middot;</span><span>{{ torrent.category }}</span>{% endif %}
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% elif download_snapshot.connected %}
                            <p class="text-xs text-base-content/60">No active downloads right now.</p>
                        {% else %}
                            <p class="text-xs text-base-content/60">{{ download_snapshot.error or 'Download client unavailable.' }}</p>
                        {% endif %}
                    </div>
                </section>
            </aside>
        </section>
    </div>
</div>
{% endblock %}
