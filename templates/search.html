{% extends 'base.html' %}
{% block title %}Search Audible{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
{% endblock %}

{% block content %}
<section class="search-page mx-auto px-6 py-8">
    <div class="search-controls card bg-base-200 border border-base-content/10 shadow-md">
        <div class="card-body gap-5">
            <div class="join w-full search-form-container">
                <input type="search" id="search-query" class="join-item input input-bordered input-lg w-full search-query-input" placeholder="Search for books, authors, series..." aria-label="Search query" value="{{ query or '' }}">
                <button class="join-item btn btn-primary btn-lg" id="search-go" type="button">
                    <i class="fas fa-search"></i>
                    <span class="hidden sm:inline">Search</span>
                </button>
            </div>
            <div class="search-toolbar flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
                <div class="search-view-toggle btn-group">
                    <button id="search-view-grid" type="button" class="btn btn-sm btn-ghost view-toggle-btn" aria-label="Grid view">
                        <i class="fas fa-grip"></i>
                        <span class="hidden sm:inline">Grid</span>
                    </button>
                    <button id="search-view-list" type="button" class="btn btn-sm btn-ghost view-toggle-btn" aria-label="List view">
                            <i class="fas fa-list"></i>
                        <span class="hidden sm:inline">List</span>
                    </button>
                    <button id="search-view-table" type="button" class="btn btn-sm btn-ghost view-toggle-btn" aria-label="Table view">
                        <i class="fas fa-table"></i>
                        <span class="hidden sm:inline">Table</span>
                    </button>
                </div>
                <div class="search-filter-group flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-end">
                    <label class="form-control w-full sm:w-56">
                        <span class="label-text text-xs uppercase tracking-wide text-base-content/60">Filter</span>
                        <select class="select select-bordered select-sm" id="search-filter">
                            <option value="">All Results</option>
                            <option value="in_library">In Library</option>
                            <option value="not_in_library">Not in Library</option>
                            <option value="wanted">Wanted</option>
                            <option value="downloadable">Downloadable</option>
                        </select>
                    </label>
                    <label class="form-control w-full sm:w-56">
                        <span class="label-text text-xs uppercase tracking-wide text-base-content/60">Sort</span>
                        <select class="select select-bordered select-sm" id="search-sort">
                            <option value="relevance">Sort by Relevance</option>
                            <option value="title">Sort by Title</option>
                            <option value="author">Sort by Author</option>
                            <option value="rating">Sort by Rating</option>
                            <option value="release_date">Sort by Release Date</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>
    </div>

    {% if search_stats.error %}
    <div class="alert alert-error shadow-lg">
        <i class="fas fa-triangle-exclamation"></i>
        <span>{{ search_stats.error }}</span>
    </div>
    {% endif %}

    <div id="search-stats" class="search-stats card bg-base-200 border border-base-content/10 shadow-sm" {% if results %}style="display: flex;"{% else %}style="display: none;"{% endif %}>
        <div class="card-body flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div class="stats-info text-sm">
                <span class="results-count font-semibold">{% if results %}{{ results|length }} result{% if results|length != 1 %}s{% endif %}{% if query %} for "{{ query }}"{% endif %}{% else %}0 results{% endif %}</span>
                <span class="search-time text-base-content/60 block md:inline md:ml-3"></span>
            </div>
            {% if search_stats and not search_stats.error %}
            <div class="search-stats-meta flex flex-wrap gap-3 text-xs uppercase tracking-wide text-base-content/60">
                {% if search_stats.total_results is not none %}<span class="stats-pill"><i class="fas fa-list-ul"></i><span>Total: {{ search_stats.total_results }}</span></span>{% endif %}
                {% if search_stats.in_library is not none %}<span class="stats-pill"><i class="fas fa-check-circle"></i><span>In Library: {{ search_stats.in_library }}</span></span>{% endif %}
                {% if search_stats.wanted is defined %}<span class="stats-pill"><i class="fas fa-star"></i><span>Wanted: {{ search_stats.wanted }}</span></span>{% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <div id="search-results" class="search-results-container" aria-live="polite" data-view="grid">
        {% if results %}
            {% for book in results %}
                {% include 'partials/search_card_classic.html' %}
            {% endfor %}
        {% endif %}
    </div>

    <div id="search-empty" class="search-empty" style="display: none;">
        <div class="empty-state card bg-base-200 border border-base-content/10 shadow-lg">
            <div class="card-body items-center text-center gap-4">
                <i class="fas fa-search text-4xl text-base-content/40"></i>
                <h3 class="text-xl font-semibold">No results found</h3>
                <p>No books found for that search. Try a different term or check the spelling.</p>
                <div class="empty-suggestions">
                    <h4 class="font-medium">Search tips</h4>
                    <ul class="list-disc text-left text-sm text-base-content/70 space-y-1">
                        <li>Search by author name</li>
                        <li>Try a series title</li>
                        <li>Use partial book titles</li>
                        <li>Check spelling before retrying</li>
                    </ul>
                </div>
            </div>
        </div>
    <div class="search-welcome card bg-base-200 border border-base-content/10 shadow-lg" style="display: none;">
            <div class="card-body gap-4">
                <div class="flex items-start gap-4">
                    <div class="avatar placeholder">
                        <div class="bg-primary text-primary-content rounded-full w-14"><i class="fas fa-compass text-2xl"></i></div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold">Start your next listening adventure</h3>
                        <p class="text-base-content/70">Search by title, author, series, or narrator. You can queue books directly into your library or inspect enhanced metadata.</p>
                    </div>
                </div>
                <div class="search-examples">
                    <h4 class="font-medium mb-2">Popular searches</h4>
                    <div class="example-queries flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-secondary" onclick="searchExample('Brandon Sanderson')">Brandon Sanderson</button>
                        <button class="btn btn-sm btn-secondary" onclick="searchExample('Atomic Habits')">Atomic Habits</button>
                        <button class="btn btn-sm btn-secondary" onclick="searchExample('Harry Potter')">Harry Potter</button>
                        <button class="btn btn-sm btn-secondary" onclick="searchExample('The Expanse')">The Expanse</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="search-loading" class="search-loading" style="display: none;">
        <div class="loading loading-lg text-primary"></div>
        <p class="text-base-content/70">Searching Audible...</p>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script id="search-bootstrap" type="application/json">{{ (results or []) | tojson }}</script>
<script src="{{ url_for('static', filename='js/search.js') }}" defer></script>
<script>
function searchExample(query) {
    const searchInput = document.getElementById('search-query');
    if (!searchInput) {
        return;
    }
    searchInput.value = query;
    if (typeof window.__aaSearch === 'function') {
        window.__aaSearch();
    } else {
        const trigger = document.getElementById('search-go');
        trigger?.click();
    }
}
</script>
{% endblock %}
